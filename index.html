<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Transporte Universit√°rio</title>
    <!-- Carregando Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!--
      Carregando a biblioteca sql.js (sql-wasm.js)
      Esta √© a biblioteca que permite criar bancos SQLite no navegador
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>

    <style>
        /* Estilo customizado para o foco dos inputs */
        .form-input:focus {
            border-color: #34d399; /* Verde */
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.5);
            outline: none;
        }
        /* Cor da borda ativa da aba */
        .tab-active {
            border-color: #34d399 !important;
            color: #34d399 !important;
        }
    </style>
</head>
<body class="bg-gray-900 font-sans">

    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">

            <!-- Se√ß√£o de Inicializa√ß√£o -->
            <div id="loaderSection" class="bg-gray-800 shadow-2xl rounded-2xl p-8 border-t-4 border-green-500">
                <h2 class="text-3xl font-bold text-white mb-6 text-center">Sistema de Transporte Universit√°rio</h2>
                <p class="text-gray-400 text-center mb-6">Clique no bot√£o abaixo para iniciar o sistema</p>
                
                <button id="initSystemButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                    Iniciar Sistema
                </button>
                <div id="loaderMessage" class="mt-6 text-center text-sm font-medium">
                    <!-- Mensagens de status do carregamento -->
                </div>
            </div>

            <!-- Card Principal (Login/Cadastro) - Escondido inicialmente -->
            <div id="authSection" class="hidden bg-gray-800 shadow-2xl rounded-2xl overflow-hidden border-t-4 border-green-500">

                <!-- Abas (Tabs) -->
                <div class="flex border-b border-gray-700">
                    <button id="tabLogin" class="flex-1 py-4 px-6 text-center font-semibold text-gray-400 border-b-2 border-transparent hover:text-green-400 focus:outline-none tab-active">
                        Login
                    </button>
                    <button id="tabRegister" class="flex-1 py-4 px-6 text-center font-semibold text-gray-400 border-b-2 border-transparent hover:text-green-400 focus:outline-none">
                        Cadastro
                    </button>
                </div>

                <div class="p-8">

                    <!-- Formul√°rio de Login -->
                    <form id="loginForm">
                        <h2 class="text-3xl font-bold text-white mb-6 text-center">Acessar Sistema</h2>

                        <div class="mb-5">
                            <label for="loginEmail" class="block mb-2 text-sm font-medium text-gray-300">Email</label>
                            <input type="email" id="loginEmail" class="form-input w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:bg-gray-600" placeholder="voce@email.com" required>
                        </div>

                        <div class="mb-8">
                            <label for="loginPassword" class="block mb-2 text-sm font-medium text-gray-300">Senha</label>
                            <input type="password" id="loginPassword" class="form-input w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:bg-gray-600" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        </div>

                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                            Entrar
                        </button>
                    </form>

                    <!-- Formul√°rio de Cadastro (Escondido por padr√£o) -->
                    <form id="registerForm" class="hidden">
                        <h2 class="text-3xl font-bold text-white mb-6 text-center">Criar Conta</h2>

                        <div class="mb-5">
                            <label for="registerEmail" class="block mb-2 text-sm font-medium text-gray-300">Email</label>
                            <input type="email" id="registerEmail" class="form-input w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:bg-gray-600" placeholder="voce@email.com" required>
                        </div>

                        <div class="mb-5">
                            <label for="registerPassword" class="block mb-2 text-sm font-medium text-gray-300">Senha</label>
                            <input type="password" id="registerPassword" class="form-input w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:bg-gray-600" placeholder="M√≠nimo 6 caracteres" required>
                        </div>

                        <div class="mb-8">
                            <label for="confirmPassword" class="block mb-2 text-sm font-medium text-gray-300">Confirmar Senha</label>
                            <input type="password" id="confirmPassword" class="form-input w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-500 focus:bg-gray-600" placeholder="Repita a senha" required>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            Cadastrar
                        </button>
                    </form>

                    <!-- √Årea de Mensagens -->
                    <div id="message" class="mt-6 text-center text-sm font-medium">
                        <!-- Mensagens de sucesso ou erro aparecer√£o aqui -->
                    </div>

                </div>
            </div>

            <!-- Dashboard Principal - Escondido inicialmente -->
            <div id="dashboardSection" class="hidden bg-gray-800 shadow-2xl rounded-2xl overflow-hidden border-t-4 border-green-500">
                <div class="p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-white">Sistema de Transporte</h2>
                        <button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                            Sair
                        </button>
                    </div>

                    <!-- Informa√ß√µes do Usu√°rio -->
                    <div id="userInfo" class="bg-gray-700 rounded-lg p-4 mb-6">
                        <h3 class="text-xl font-semibold text-white mb-2">Informa√ß√µes do Usu√°rio</h3>
                        <p class="text-gray-300" id="userEmail"></p>
                    </div>

                    <!-- Abas do Dashboard -->
                    <div class="flex border-b border-gray-700 mb-6">
                        <button id="tabRotas" class="flex-1 py-3 px-4 text-center font-semibold text-gray-400 border-b-2 border-transparent hover:text-green-400 focus:outline-none tab-active">
                            Rotas
                        </button>
                        <button id="tabHorarios" class="flex-1 py-3 px-4 text-center font-semibold text-gray-400 border-b-2 border-transparent hover:text-green-400 focus:outline-none">
                            Hor√°rios
                        </button>
                        <button id="tabReservas" class="flex-1 py-3 px-4 text-center font-semibold text-gray-400 border-b-2 border-transparent hover:text-green-400 focus:outline-none">
                            Minhas Reservas
                        </button>
                    </div>

                    <!-- Conte√∫do das Abas -->
                    <div id="dashboardContent">
                        <!-- Conte√∫do da aba Rotas -->
                        <div id="rotasContent">
                            <h3 class="text-xl font-semibold text-white mb-4">Rotas Dispon√≠veis</h3>
                            <div id="rotasList" class="space-y-4">
                                <!-- As rotas ser√£o carregadas dinamicamente aqui -->
                            </div>
                        </div>

                        <!-- Conte√∫do da aba Hor√°rios -->
                        <div id="horariosContent" class="hidden">
                            <h3 class="text-xl font-semibold text-white mb-4">Hor√°rios dos √înibus</h3>
                            <div id="horariosList" class="space-y-4">
                                <!-- Os hor√°rios ser√£o carregados dinamicamente aqui -->
                            </div>
                        </div>

                        <!-- Conte√∫do da aba Reservas -->
                        <div id="reservasContent" class="hidden">
                            <h3 class="text-xl font-semibold text-white mb-4">Minhas Reservas</h3>
                            <div id="reservasList" class="space-y-4">
                                <!-- As reservas ser√£o carregadas dinamicamente aqui -->
                            </div>
                        </div>
                    </div>

                    <!-- √Årea de Mensagens do Dashboard -->
                    <div id="dashboardMessage" class="mt-6 text-center text-sm font-medium">
                        <!-- Mensagens aparecer√£o aqui -->
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Sele√ß√£o de Assentos - Escondida inicialmente -->
            <div id="seatsSection" class="hidden bg-gray-800 shadow-2xl rounded-2xl overflow-hidden border-t-4 border-green-500">
                <div class="p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-white">Selecione seu Assento</h2>
                        <button id="backFromSeats" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                            Voltar
                        </button>
                    </div>

                    <!-- Informa√ß√µes do Hor√°rio Selecionado -->
                    <div id="seatsTripInfo" class="bg-gray-700 rounded-lg p-4 mb-6">
                        <h3 class="text-xl font-semibold text-white mb-2">Informa√ß√µes da Viagem</h3>
                        <p class="text-gray-300" id="seatsTripDetails"></p>
                    </div>

                    <!-- Visualiza√ß√£o do √înibus (Top-Down) -->
                    <div class="bg-gray-700 rounded-lg p-6 mb-6 overflow-x-auto">
                        <div class="text-center mb-4">
                            <p class="text-green-400 font-semibold mb-4">FRENTE DO √îNIBUS üöå</p>
                        </div>

                        <!-- Grid de Assentos -->
                        <div id="seatsGrid" class="inline-block">
                            <!-- Assentos ser√£o gerados dinamicamente -->
                        </div>

                        <div class="text-center mt-4">
                            <p class="text-green-400 font-semibold">FUNDO DO √îNIBUS</p>
                        </div>
                    </div>

                    <!-- Legenda de Assentos -->
                    <div class="bg-gray-700 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-white mb-3">Legenda:</h3>
                        <div class="flex flex-wrap gap-6">
                            <div class="flex items-center gap-2">
                                <button class="w-8 h-8 bg-gray-600 border-2 border-gray-500 rounded cursor-not-allowed"></button>
                                <span class="text-gray-300">Dispon√≠vel</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="w-8 h-8 bg-green-600 border-2 border-green-500 rounded"></button>
                                <span class="text-gray-300">Selecionado</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="w-8 h-8 bg-red-600 border-2 border-red-500 rounded cursor-not-allowed" disabled></button>
                                <span class="text-gray-300">Ocupado</span>
                            </div>
                        </div>
                    </div>

                    <!-- Assento Selecionado e Bot√£o de Confirma√ß√£o -->
                    <div id="seatsSelectionInfo" class="bg-gray-700 rounded-lg p-4 mb-6 text-center">
                        <p class="text-gray-400 mb-3">Assento selecionado: <span id="selectedSeatNumber" class="text-green-400 font-bold">Nenhum</span></p>
                        <button id="confirmSeatButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Confirmar Assento
                        </button>
                    </div>

                    <!-- √Årea de Mensagens -->
                    <div id="seatsMessage" class="mt-6 text-center text-sm font-medium">
                        <!-- Mensagens de sucesso ou erro aparecer√£o aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Vari√°vel Global do Banco de Dados ---
        let db; // Ir√° guardar a inst√¢ncia do banco de dados em mem√≥ria
        let SQL; // Ir√° guardar o motor do sql.js
        let currentUser = null; // Ir√° guardar o usu√°rio logado
        let selectedSeat = null; // Ir√° guardar o assento selecionado
        let currentTripInfo = null; // Ir√° guardar informa√ß√µes do hor√°rio selecionado

        // --- Seletores do DOM ---
        const loaderSection = document.getElementById('loaderSection');
        const authSection = document.getElementById('authSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const initSystemButton = document.getElementById('initSystemButton');
        const loaderMessage = document.getElementById('loaderMessage');

        const tabLogin = document.getElementById('tabLogin');
        const tabRegister = document.getElementById('tabRegister');

        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');

        const message = document.getElementById('message');
        const logoutButton = document.getElementById('logoutButton');
        const userInfo = document.getElementById('userInfo');
        const userEmail = document.getElementById('userEmail');

        // Abas do Dashboard
        const tabRotas = document.getElementById('tabRotas');
        const tabHorarios = document.getElementById('tabHorarios');
        const tabReservas = document.getElementById('tabReservas');

        // Conte√∫do das abas
        const rotasContent = document.getElementById('rotasContent');
        const horariosContent = document.getElementById('horariosContent');
        const reservasContent = document.getElementById('reservasContent');

        // Listas de conte√∫do
        const rotasList = document.getElementById('rotasList');
        const horariosList = document.getElementById('horariosList');
        const reservasList = document.getElementById('reservasList');

        const dashboardMessage = document.getElementById('dashboardMessage');

        // Seletores para a se√ß√£o de assentos
        const seatsSection = document.getElementById('seatsSection');
        const seatsGrid = document.getElementById('seatsGrid');
        const selectedSeatNumber = document.getElementById('selectedSeatNumber');
        const confirmSeatButton = document.getElementById('confirmSeatButton');
        const seatsMessage = document.getElementById('seatsMessage');
        const backFromSeats = document.getElementById('backFromSeats');
        const seatsTripInfo = document.getElementById('seatsTripInfo');
        const seatsTripDetails = document.getElementById('seatsTripDetails');

        // --- Fun√ß√£o para mostrar mensagens ---
        function showMessage(text, type, target = 'message') {
            const el = document.getElementById(target);
            el.textContent = text;
            if (type === 'error') {
                el.className = 'mt-6 text-center text-sm font-medium text-red-400';
            } else if (type === 'success') {
                el.className = 'mt-6 text-center text-sm font-medium text-green-400';
            } else {
                el.className = 'mt-6 text-center text-sm font-medium text-gray-400';
            }
        }

        // --- L√≥gica de Inicializa√ß√£o do Sistema ---
        initSystemButton.addEventListener('click', async () => {
            showMessage('Iniciando sistema...', 'info', 'loaderMessage');

            try {
                // 1. Inicia o motor sql.js
                if (!SQL) {
                    SQL = await initSqlJs({
                        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
                    });
                }

                showMessage('Criando banco de dados...', 'info', 'loaderMessage');

                // 2. Cria um novo banco de dados em mem√≥ria
                db = new SQL.Database();

                // 3. Cria as tabelas necess√°rias
                db.run(`
                    CREATE TABLE IF NOT EXISTS users (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        email TEXT UNIQUE NOT NULL,
                        password TEXT NOT NULL,
                        tipo TEXT DEFAULT 'aluno'
                    );
                `);

                db.run(`
                    CREATE TABLE IF NOT EXISTS rotas (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        nome TEXT NOT NULL,
                        origem TEXT NOT NULL,
                        destino TEXT NOT NULL,
                        descricao TEXT
                    );
                `);

                db.run(`
                    CREATE TABLE IF NOT EXISTS horarios (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        rota_id INTEGER NOT NULL,
                        horario_saida TEXT NOT NULL,
                        FOREIGN KEY (rota_id) REFERENCES rotas(id)
                    );
                `);

                db.run(`
                    CREATE TABLE IF NOT EXISTS reservas (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        user_id INTEGER NOT NULL,
                        rota_id INTEGER NOT NULL,
                        horario_id INTEGER NOT NULL,
                        data_reserva TEXT NOT NULL,
                        status TEXT DEFAULT 'ativa',
                        assento_numero INTEGER,
                        FOREIGN KEY (user_id) REFERENCES users(id),
                        FOREIGN KEY (rota_id) REFERENCES rotas(id),
                        FOREIGN KEY (horario_id) REFERENCES horarios(id)
                    );
                `);

                // 4. Insere dados de exemplo
                // Verificar se j√° existem rotas
                const rotasCount = db.exec("SELECT COUNT(*) as count FROM rotas");
                if (rotasCount[0].values[0][0] === 0) {
                    // Inserir rotas de exemplo
                    db.run("INSERT INTO rotas (nome, origem, destino, descricao) VALUES (?, ?, ?, ?)", 
                        ["Campus Central", "Centro", "Campus Universit√°rio", "Rota principal do campus"]);
                    db.run("INSERT INTO rotas (nome, origem, destino, descricao) VALUES (?, ?, ?, ?)", 
                        ["Zona Norte", "Zona Norte", "Campus Universit√°rio", "Atende bairros da zona norte"]);
                    db.run("INSERT INTO rotas (nome, origem, destino, descricao) VALUES (?, ?, ?, ?)", 
                        ["Zona Sul", "Zona Sul", "Campus Universit√°rio", "Atende bairros da zona sul"]);
                    
                    // Inserir hor√°rios de exemplo
                    db.run("INSERT INTO horarios (rota_id, horario_saida) VALUES (?, ?)", [1, "07:00"]);
                    db.run("INSERT INTO horarios (rota_id, horario_saida) VALUES (?, ?)", [1, "08:30"]);
                    db.run("INSERT INTO horarios (rota_id, horario_saida) VALUES (?, ?)", [1, "10:00"]);
                    db.run("INSERT INTO horarios (rota_id, horario_saida) VALUES (?, ?)", [2, "07:15"]);
                    db.run("INSERT INTO horarios (rota_id, horario_saida) VALUES (?, ?)", [2, "09:00"]);
                    db.run("INSERT INTO horarios (rota_id, horario_saida) VALUES (?, ?)", [3, "07:30"]);
                    db.run("INSERT INTO horarios (rota_id, horario_saida) VALUES (?, ?)", [3, "09:30"]);
                    
                    // Inserir um usu√°rio admin de exemplo
                    db.run("INSERT INTO users (email, password, tipo) VALUES (?, ?, ?)", 
                        ["admin@universidade.com", "123456", "admin"]);
                }

                showMessage('Sistema carregado com sucesso!', 'success', 'loaderMessage');

                // 5. Esconde o loader e mostra a tela de login
                setTimeout(() => {
                    loaderSection.classList.add('hidden');
                    authSection.classList.remove('hidden');
                }, 1000);

            } catch (err) {
                console.error(err);
                showMessage(`Erro ao iniciar o sistema: ${err.message}`, 'error', 'loaderMessage');
            }
        });

        // --- L√≥gica das Abas ---
        tabLogin.addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            tabLogin.classList.add('tab-active');
            tabRegister.classList.remove('tab-active');
            message.textContent = '';
        });

        tabRegister.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            tabLogin.classList.remove('tab-active');
            tabRegister.classList.add('tab-active');
            message.textContent = '';
        });

        // --- L√≥gica de Cadastro ---
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showMessage('As senhas n√£o conferem.', 'error');
                return;
            }
            if (password.length < 6) {
                showMessage('A senha deve ter pelo menos 6 caracteres.', 'error');
                return;
            }

            try {
                // Executa o INSERT no banco de dados em mem√≥ria
                db.run("INSERT INTO users (email, password) VALUES (?, ?)", [email, password]);

                showMessage('Usu√°rio cadastrado com sucesso!', 'success');
                registerForm.reset();

                // Mude para a aba de login
                setTimeout(() => {
                    tabLogin.click();
                }, 1000);

            } catch (err) {
                if (err.message.includes("UNIQUE constraint failed")) {
                    showMessage('Este email j√° est√° cadastrado.', 'error');
                } else {
                    showMessage(`Erro ao cadastrar: ${err.message}`, 'error');
                }
                console.error(err);
            }
        });

        // --- L√≥gica de Login ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                // Prepara a query SQL para evitar SQL injection
                const stmt = db.prepare("SELECT * FROM users WHERE email = :email AND password = :pass");

                // Associa os valores
                stmt.bind({ ':email': email, ':pass': password });

                // Executa a query e verifica se retornou uma linha
                if (stmt.step()) {
                    const user = stmt.getAsObject(); // Pega os dados do usu√°rio
                    currentUser = user;
                    
                    showMessage(`Login bem-sucedido! Bem-vindo, ${user.email}.`, 'success');
                    loginForm.reset();

                    // Mostra o dashboard
                    authSection.classList.add('hidden');
                    dashboardSection.classList.remove('hidden');
                    
                    // Atualiza informa√ß√µes do usu√°rio
                    userEmail.textContent = `Email: ${user.email}`;
                    
                    // Carrega as rotas
                    carregarRotas();
                    
                } else {
                    showMessage('Email ou senha inv√°lidos.', 'error');
                }

                // Libera o statement da mem√≥ria
                stmt.free();

            } catch (err) {
                showMessage(`Erro ao fazer login: ${err.message}`, 'error');
                console.error(err);
            }
        });

        // --- L√≥gica do Logout ---
        logoutButton.addEventListener('click', () => {
            currentUser = null;
            dashboardSection.classList.add('hidden');
            authSection.classList.remove('hidden');
            showMessage('Logout realizado com sucesso!', 'success');
        });

        // --- L√≥gica da Se√ß√£o de Assentos ---
        backFromSeats.addEventListener('click', () => {
            seatsSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            selectedSeat = null;
            currentTripInfo = null;
        });

        confirmSeatButton.addEventListener('click', () => {
            try {
                if (selectedSeat === null) {
                    showMessage('Selecione um assento primeiro!', 'error', 'seatsMessage');
                    return;
                }
                
                if (!currentTripInfo) {
                    showMessage('Informa√ß√µes da viagem n√£o encontradas.', 'error', 'seatsMessage');
                    return;
                }
                
                const dataAtual = new Date().toISOString().split('T')[0];
                const horarioId = currentTripInfo.horarioId;
                
                // Verificar se j√° existe uma reserva ativa para este hor√°rio
                const verificaReserva = db.exec(`
                    SELECT * FROM reservas 
                    WHERE user_id = ${currentUser.id} 
                    AND horario_id = ${horarioId} 
                    AND status = 'ativa'
                `);
                
                if (verificaReserva.length > 0 && verificaReserva[0].values.length > 0) {
                    showMessage('Voc√™ j√° tem uma reserva ativa para este hor√°rio.', 'error', 'seatsMessage');
                    return;
                }
                
                // Obter o rota_id a partir do horario_id
                const rotaResult = db.exec(`SELECT rota_id FROM horarios WHERE id = ${horarioId}`);
                if (rotaResult.length === 0) {
                    showMessage('Erro ao obter informa√ß√µes da rota.', 'error', 'seatsMessage');
                    return;
                }
                
                const rotaId = rotaResult[0].values[0][0];
                
                // Fazer a reserva com o assento selecionado
                db.run(
                    "INSERT INTO reservas (user_id, rota_id, horario_id, data_reserva, assento_numero) VALUES (?, ?, ?, ?, ?)", 
                    [currentUser.id, rotaId, horarioId, dataAtual, selectedSeat]
                );
                
                showMessage(`Reserva confirmada! Assento ${selectedSeat} - ${currentTripInfo.rotaNome} √†s ${currentTripInfo.horario}`, 'success', 'seatsMessage');
                
                // Voltar para o dashboard e ir para a aba de reservas
                setTimeout(() => {
                    seatsSection.classList.add('hidden');
                    dashboardSection.classList.remove('hidden');
                    tabReservas.click();
                    selectedSeat = null;
                    currentTripInfo = null;
                }, 1500);
                
            } catch (err) {
                console.error('Erro ao confirmar assento:', err);
                if (err.message.includes('no such column')) {
                    showMessage('Atualizando banco de dados...', 'info', 'seatsMessage');
                    // Tentar adicionar coluna assento_numero √† tabela reservas
                    try {
                        db.run("ALTER TABLE reservas ADD COLUMN assento_numero INTEGER");
                        confirmSeatButton.click(); // Tentar novamente
                    } catch (altErr) {
                        console.log('Coluna pode j√° existir');
                    }
                } else {
                    showMessage('Erro ao confirmar reserva.', 'error', 'seatsMessage');
                }
            }
        });

        // --- L√≥gica das Abas do Dashboard ---
        tabRotas.addEventListener('click', () => {
            rotasContent.classList.remove('hidden');
            horariosContent.classList.add('hidden');
            reservasContent.classList.add('hidden');
            tabRotas.classList.add('tab-active');
            tabHorarios.classList.remove('tab-active');
            tabReservas.classList.remove('tab-active');
            
            carregarRotas();
        });

        tabHorarios.addEventListener('click', () => {
            rotasContent.classList.add('hidden');
            horariosContent.classList.remove('hidden');
            reservasContent.classList.add('hidden');
            tabRotas.classList.remove('tab-active');
            tabHorarios.classList.add('tab-active');
            tabReservas.classList.remove('tab-active');
            
            carregarHorarios();
        });

        tabReservas.addEventListener('click', () => {
            rotasContent.classList.add('hidden');
            horariosContent.classList.add('hidden');
            reservasContent.classList.remove('hidden');
            tabRotas.classList.remove('tab-active');
            tabHorarios.classList.remove('tab-active');
            tabReservas.classList.add('tab-active');
            
            carregarReservas();
        });

        // --- Fun√ß√µes para carregar dados ---
        function carregarRotas() {
            try {
                const result = db.exec("SELECT * FROM rotas");
                if (result.length > 0) {
                    const rotas = result[0].values;
                    rotasList.innerHTML = '';
                    
                    rotas.forEach(rota => {
                        const rotaDiv = document.createElement('div');
                        rotaDiv.className = 'bg-gray-700 rounded-lg p-4';
                        rotaDiv.innerHTML = `
                            <h4 class="text-lg font-semibold text-white">${rota[1]}</h4>
                            <p class="text-gray-300">De: ${rota[2]} Para: ${rota[3]}</p>
                            <p class="text-gray-400 text-sm mt-2">${rota[4] || 'Sem descri√ß√£o'}</p>
                            <button class="mt-3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out ver-horarios" data-rota-id="${rota[0]}">
                                Ver Hor√°rios
                            </button>
                        `;
                        rotasList.appendChild(rotaDiv);
                    });
                    
                    // Adicionar eventos aos bot√µes "Ver Hor√°rios"
                    document.querySelectorAll('.ver-horarios').forEach(button => {
                        button.addEventListener('click', function() {
                            const rotaId = this.getAttribute('data-rota-id');
                            tabHorarios.click();
                            carregarHorarios(rotaId);
                        });
                    });
                } else {
                    rotasList.innerHTML = '<p class="text-gray-400">Nenhuma rota dispon√≠vel.</p>';
                }
            } catch (err) {
                console.error('Erro ao carregar rotas:', err);
                rotasList.innerHTML = '<p class="text-red-400">Erro ao carregar rotas.</p>';
            }
        }

        function carregarHorarios(rotaIdFiltro = null) {
            try {
                let query = `
                    SELECT h.id, r.nome, h.horario_saida, r.origem, r.destino 
                    FROM horarios h 
                    JOIN rotas r ON h.rota_id = r.id
                `;
                
                if (rotaIdFiltro) {
                    query += ` WHERE r.id = ${rotaIdFiltro}`;
                }
                
                query += " ORDER BY r.nome, h.horario_saida";
                
                const result = db.exec(query);
                if (result.length > 0) {
                    const horarios = result[0].values;
                    horariosList.innerHTML = '';
                    
                    horarios.forEach(horario => {
                        const horarioDiv = document.createElement('div');
                        horarioDiv.className = 'bg-gray-700 rounded-lg p-4';
                        horarioDiv.innerHTML = `
                            <h4 class="text-lg font-semibold text-white">${horario[1]}</h4>
                            <p class="text-gray-300">Hor√°rio: ${horario[2]}</p>
                            <p class="text-gray-300">De: ${horario[3]} Para: ${horario[4]}</p>
                            <button class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out fazer-reserva" data-horario-id="${horario[0]}" data-rota-nome="${horario[1]}" data-horario="${horario[2]}">
                                Fazer Reserva
                            </button>
                        `;
                        horariosList.appendChild(horarioDiv);
                    });
                    
                    // Adicionar eventos aos bot√µes "Fazer Reserva"
                    document.querySelectorAll('.fazer-reserva').forEach(button => {
                        button.addEventListener('click', function() {
                            const horarioId = this.getAttribute('data-horario-id');
                            const rotaNome = this.getAttribute('data-rota-nome');
                            const horario = this.getAttribute('data-horario');
                            fazerReserva(horarioId, rotaNome, horario);
                        });
                    });
                } else {
                    horariosList.innerHTML = '<p class="text-gray-400">Nenhum hor√°rio dispon√≠vel.</p>';
                }
            } catch (err) {
                console.error('Erro ao carregar hor√°rios:', err);
                horariosList.innerHTML = '<p class="text-red-400">Erro ao carregar hor√°rios.</p>';
            }
        }

        function carregarReservas() {
            try {
                const result = db.exec(`
                    SELECT rv.id, rt.nome, h.horario_saida, rv.data_reserva, rv.status, rv.assento_numero 
                    FROM reservas rv 
                    JOIN rotas rt ON rv.rota_id = rt.id 
                    JOIN horarios h ON rv.horario_id = h.id 
                    WHERE rv.user_id = ${currentUser.id}
                    ORDER BY rv.data_reserva DESC
                `);
                
                if (result.length > 0) {
                    const reservas = result[0].values;
                    reservasList.innerHTML = '';
                    
                    reservas.forEach(reserva => {
                        const reservaDiv = document.createElement('div');
                        reservaDiv.className = 'bg-gray-700 rounded-lg p-4';
                        
                        let statusClass = 'text-yellow-400';
                        if (reserva[4] === 'ativa') {
                            statusClass = 'text-green-400';
                        } else if (reserva[4] === 'cancelada') {
                            statusClass = 'text-red-400';
                        }
                        
                        const assentoInfo = reserva[5] ? `<p class="text-gray-300">Assento: <span class="text-blue-400 font-semibold">#${reserva[5]}</span></p>` : '';
                        
                        reservaDiv.innerHTML = `
                            <h4 class="text-lg font-semibold text-white">${reserva[1]}</h4>
                            <p class="text-gray-300">Hor√°rio: ${reserva[2]}</p>
                            <p class="text-gray-300">Data da Reserva: ${reserva[3]}</p>
                            ${assentoInfo}
                            <p class="${statusClass} font-semibold">Status: ${reserva[4]}</p>
                            ${reserva[4] === 'ativa' ? 
                                `<button class="mt-3 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out cancelar-reserva" data-reserva-id="${reserva[0]}">
                                    Cancelar Reserva
                                </button>` : 
                                ''
                            }
                        `;
                        reservasList.appendChild(reservaDiv);
                    });
                    
                    // Adicionar eventos aos bot√µes "Cancelar Reserva"
                    document.querySelectorAll('.cancelar-reserva').forEach(button => {
                        button.addEventListener('click', function() {
                            const reservaId = this.getAttribute('data-reserva-id');
                            cancelarReserva(reservaId);
                        });
                    });
                } else {
                    reservasList.innerHTML = '<p class="text-gray-400">Nenhuma reserva encontrada.</p>';
                }
            } catch (err) {
                console.error('Erro ao carregar reservas:', err);
                reservasList.innerHTML = '<p class="text-red-400">Erro ao carregar reservas.</p>';
            }
        }

        // --- Fun√ß√µes para opera√ß√µes ---
        function fazerReserva(horarioId, rotaNome, horario) {
            try {
                // Armazenar informa√ß√µes da viagem selecionada
                currentTripInfo = {
                    horarioId: horarioId,
                    rotaNome: rotaNome,
                    horario: horario
                };
                
                // Mostrar informa√ß√µes na se√ß√£o de assentos
                seatsTripDetails.textContent = `${rotaNome} - ${horario}`;
                
                // Resetar sele√ß√£o de assento
                selectedSeat = null;
                selectedSeatNumber.textContent = 'Nenhum';
                confirmSeatButton.disabled = true;
                
                // Gerar assentos
                gerarAssentos();
                
                // Mudar para a se√ß√£o de assentos
                dashboardSection.classList.add('hidden');
                seatsSection.classList.remove('hidden');
                seatsMessage.textContent = '';
                
            } catch (err) {
                console.error('Erro ao iniciar sele√ß√£o de assentos:', err);
                showMessage('Erro ao acessar sele√ß√£o de assentos.', 'error', 'dashboardMessage');
            }
        }

        function cancelarReserva(reservaId) {
            try {
                db.run("UPDATE reservas SET status = 'cancelada' WHERE id = ?", [reservaId]);
                showMessage('Reserva cancelada com sucesso!', 'success', 'dashboardMessage');
                carregarReservas();
            } catch (err) {
                console.error('Erro ao cancelar reserva:', err);
                showMessage('Erro ao cancelar reserva.', 'error', 'dashboardMessage');
            }
        }

        // --- Fun√ß√µes para Sele√ß√£o de Assentos ---
        function gerarAssentos() {
            seatsGrid.innerHTML = '';
            
            // Criar container para o grid de assentos (2 colunas de 2 assentos separadas por corredor)
            const seatsContainer = document.createElement('div');
            seatsContainer.className = 'flex flex-col gap-3 justify-center';
            
            let seatNumber = 1;
            
            // 10 linhas de assentos
            for (let linha = 1; linha <= 10; linha++) {
                const linhaDiv = document.createElement('div');
                linhaDiv.className = 'flex items-center justify-center gap-8';
                
                // Grupo da esquerda (2 assentos)
                const leftGroup = document.createElement('div');
                leftGroup.className = 'flex gap-2';
                
                for (let i = 0; i < 2; i++) {
                    const seatButton = criarBotaoAssento(seatNumber);
                    leftGroup.appendChild(seatButton);
                    seatNumber++;
                }
                
                linhaDiv.appendChild(leftGroup);
                
                // Corredor
                const corredor = document.createElement('div');
                corredor.className = 'w-8 h-8 flex items-center justify-center text-gray-500 font-bold';
                corredor.textContent = '||';
                linhaDiv.appendChild(corredor);
                
                // Grupo da direita (2 assentos)
                const rightGroup = document.createElement('div');
                rightGroup.className = 'flex gap-2';
                
                for (let i = 0; i < 2; i++) {
                    const seatButton = criarBotaoAssento(seatNumber);
                    rightGroup.appendChild(seatButton);
                    seatNumber++;
                }
                
                linhaDiv.appendChild(rightGroup);
                seatsContainer.appendChild(linhaDiv);
            }
            
            seatsGrid.appendChild(seatsContainer);
        }
        
        function criarBotaoAssento(numero) {
            const button = document.createElement('button');
            button.className = 'seat-button w-12 h-12 rounded font-bold text-sm border-2 transition duration-200 ease-in-out hover:scale-110 focus:outline-none bg-gray-600 border-gray-500 text-white hover:bg-gray-500 cursor-pointer';
            button.textContent = numero;
            button.dataset.seatNumber = numero;
            button.type = 'button';
            
            button.addEventListener('click', () => selecionarAssento(numero, button));
            
            return button;
        }
        
        function selecionarAssento(numero, button) {
            // Se for o mesmo assento, deselecionar
            if (selectedSeat === numero) {
                selectedSeat = null;
                selectedSeatNumber.textContent = 'Nenhum';
                button.classList.remove('bg-green-600', 'border-green-500');
                button.classList.add('bg-gray-600', 'border-gray-500');
                confirmSeatButton.disabled = true;
            } else {
                // Remover sele√ß√£o anterior
                if (selectedSeat !== null) {
                    const previousButton = document.querySelector(`[data-seat-number="${selectedSeat}"]`);
                    if (previousButton) {
                        previousButton.classList.remove('bg-green-600', 'border-green-500');
                        previousButton.classList.add('bg-gray-600', 'border-gray-500');
                    }
                }
                
                // Selecionar novo assento
                selectedSeat = numero;
                selectedSeatNumber.textContent = numero;
                button.classList.remove('bg-gray-600', 'border-gray-500');
                button.classList.add('bg-green-600', 'border-green-500');
                confirmSeatButton.disabled = false;
            }
        }
    </script>
</body>
</html>